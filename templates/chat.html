<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Dax - AI NPC Chat + Build</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100vh;
            font-family: 'Segoe UI', sans-serif;
            background-color: #111;
            color: white;
        }

        .build-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        #left-panel,
        #middle-display,
        #right-panel {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            box-sizing: border-box;
        }

        #left-panel {
            border-right: 2px solid #333;
        }

        #middle-display {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #0f0f0f;
        }

        #right-panel {
            border-left: 2px solid #333;
            display: flex;
            flex-direction: column;
        }

        .part-card {
            width: 120px;
            margin: 10px;
            padding: 10px;
            text-align: center;
            background-color: #1a1a1a;
            border: 2px solid #444;
            border-radius: 8px;
            cursor: pointer;
        }

        .part-card.selected {
            border-color: #0f0;
            background-color: #222;
        }

        .part-card img {
            width: 100px;
        }

        .part-options {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        #player_input {
            background-color: #1a1a1a;
            color: white;
            border: 1px solid #444;
            border-radius: 5px;
        }

        .chat-log {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 10px;
        }

        .chat-bubble {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 10px;
            max-width: 90%;
            line-height: 1.5;
        }

        .chat-bubble.player {
            background-color: #333;
            align-self: flex-end;
        }

        .chat-bubble.npc {
            background-color: #144d36;
            align-self: flex-start;
        }

        #player_input {
            padding: 8px;
            width: 80%;
        }

        button {
            padding: 8px 16px;
            background-color: #333;
            color: white;
            border: none;
            cursor: pointer;
            margin-left: 8px;
        }
    </style>
</head>

<body>
    <a href="/" style="margin: 10px; display: inline-block; color: #e6b800">⬅️ Back to Cover Page</a>
    <div class="build-container">

        <!-- Part Selection -->
        <div id="left-panel">
            <h2>Choose Parts</h2>
            <div class="part-group">
                <h3>Chassis</h3>
                <div class="part-options">
                    <div class="part-card" data-category="chassis" data-part="Standard"><img
                            src="/static/images/car_parts/Standard_Chassis.png">
                        <p>Standard</p>
                    </div>
                    <div class="part-card" data-category="chassis" data-part="Lightweight"><img
                            src="/static/images/car_parts/Lightweight_Chassis.png">
                        <p>Lightweight</p>
                    </div>
                </div>
            </div>
            <div class="part-group">
                <h3>Engine</h3>
                <div class="part-options">
                    <div class="part-card" data-category="engine" data-part="Turbo"><img
                            src="/static/images/car_parts/Turbo_Engine.png">
                        <p>Turbo</p>
                    </div>
                    <div class="part-card" data-category="engine" data-part="V8"><img
                            src="/static/images/car_parts/V8_Engine.png">
                        <p>V8</p>
                    </div>
                </div>
            </div>
            <div class="part-group">
                <h3>Tires</h3>
                <div class="part-options">
                    <div class="part-card" data-category="tires" data-part="Slick"><img
                            src="/static/images/car_parts/Slick_Tire.png">
                        <p>Slick</p>
                    </div>
                    <div class="part-card" data-category="tires" data-part="Wet"><img
                            src="/static/images/car_parts/Wet_Tire.png">
                        <p>Wet</p>
                    </div>
                </div>
            </div>
            <div class="part-group">
                <h3>Spoiler</h3>
                <div class="part-options">
                    <div class="part-card" data-category="spoiler" data-part="None"><img
                            src="/static/images/car_parts/No_Spoiler.png">
                        <p>None</p>
                    </div>
                    <div class="part-card" data-category="spoiler" data-part="Carbon Fiber"><img
                            src="/static/images/car_parts/Carbon_Spoiler.png">
                        <p>Carbon Fiber</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Car Preview -->
        <div id="middle-display">
            <p style="color: #aaa">Your car will appear here when ready.</p>
        </div>

        <!-- Chat Interface -->
        <div id="right-panel">
            <div class="chat-log" id="chat-log">
                <script>
                    window.addEventListener("DOMContentLoaded", () => {
                        addMessage("npc", "Welcome, racer! I'm Dax — your race engineer. Pick your car parts and ask me anything as you build.");
                    });
                </script>

            </div>
            <form onsubmit="return sendToDax(event)" style="margin-top: auto; display: flex; padding-top: 10px;">
                <input type="text" id="player_input" placeholder="Ask Dax...">
                <button type="submit">Send</button>
            </form>
        </div>
    </div>

    <script>
        const playerId = localStorage.getItem("player_id");
        if (!playerId) {
            alert("Please login again.");
            window.location.href = "/login";
        }

        const selectedParts = {
            chassis: null, engine: null, tires: null, spoiler: null
        };

        function allPartsSelected() {
            return Object.values(selectedParts).every(Boolean);
        }

        function updateCarPreview() {
            const { chassis, engine, tires, spoiler } = selectedParts;
            const display = document.getElementById("middle-display");
            if (!chassis || !engine || !tires || !spoiler) {
                display.innerHTML = `<p style='color:#aaa;'>Select all parts to preview your racecar.</p>`;
                return;
            }
            const imageName = `${chassis}_${engine}_${tires}_${spoiler}`.replace(/ /g, "_");
            const path = `/static/images/16_cars/${imageName}.png`;
            const img = new Image();
            img.src = path;
            img.alt = "Racecar Preview";
            img.style.maxWidth = "90%";
            display.innerHTML = "";
            display.appendChild(img);
        }

        document.querySelectorAll('.part-card').forEach(card => {
            card.onclick = () => {
                const category = card.dataset.category;
                const part = card.dataset.part;
                selectedParts[category] = part;
                document.querySelectorAll(`.part-card[data-category='${category}']`).forEach(c => c.classList.remove("selected"));
                card.classList.add("selected");
                updateCarPreview();
                sendToDaxSim(`I picked ${part} for ${category}.`);
            }
        });

        async function sendToDax(event) {
            event.preventDefault();
            const input = document.getElementById("player_input");
            const message = input.value.trim();
            if (!message) return;
            addMessage("player", message);
            input.value = "";
            sendToDaxSim(message);
        }

        function addMessage(role, text) {
            const chat = document.getElementById("chat-log");
            const div = document.createElement("div");
            div.className = `chat-bubble ${role}`;
            div.innerHTML = `<strong>${role === 'player' ? 'You' : 'Dax'}:</strong> ${text}`;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        async function sendToDaxSim(text) {
            const formData = new FormData();
            formData.append("player_id", playerId);
            formData.append("npc_id", 1);
            formData.append("dialogue", text);
            addMessage("npc");
            try {
                const res = await fetch("/chat_api", { 
                    method: "POST", body: formData 
                }) 
                .then(response => response.json())
                .then(data => {
                    addMessage("npc", data.npc_reply);
                })
                .catch(error => {
                    console.error("Error:", error);
                    addMessage("npc", "⚠️ Sorry, I couldn’t respond right now.");
                });
                const data = await res.json();
                addMessage("npc", data.npc_reply || "...");
                } catch {
                    addMessage("npc");
                }
            }

        fetch(`/history_api/${playerId}`)
            .then(response => response.json())
            .then(data => {
                data.forEach(entry => {
                    addMessage("player", entry.dialogue);
                    addMessage("npc", entry.npc_reply);
                });
        });
    </script>
</body>

</html>